<!DOCTYPE html>
<html>
<head>
  <title>Grooming Sessions Summary</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #121212; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #1f1f1f; }
    th, td { padding: 10px; border: 1px solid #444; text-align: left; }
    th { background-color: #2c2c2c; color: #e7e6e5; }
    td { color: #eee; }
    button {
      background-color: #d4d4d4;
      border: none;
      padding: 10px 20px;
      color: black;
      margin: 10px 5px 0 0;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Grooming Session Summaries</h2>

  <div>
    <button onclick="window.location.href='adminDashboard.html'">‚¨Ö Back to Dashboard</button>
    <button onclick="print()">üñ®Ô∏è Print</button>
    <button onclick="exportData()">üìÅ Export</button>
  </div>

  <table id="summaryTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Owner</th>
        <th>Pet</th>
        <th>Package</th>
        <th>Total</th>
        <th>Groomer</th>
      </tr>
    </thead>
    <tbody id="sessionTableBody"></tbody> 
  </table>

  <script>
    const fs = require('fs');
    const path = require('path');
    const clientPath = path.join(__dirname, 'clients.json');
    const tableBody = document.getElementById('sessionTableBody');

    let allSessions = [];

    function loadSessionsFromClients() {
      if (!fs.existsSync(clientPath)) {
        tableBody.innerHTML = '<tr><td colspan="6">clients.json not found.</td></tr>';
        return;
      }

      let clients;
      try {
        clients = JSON.parse(fs.readFileSync(clientPath, 'utf-8'));
      } catch (err) {
        console.error('Error parsing JSON:', err);
        tableBody.innerHTML = '<tr><td colspan="6">Invalid JSON format.</td></tr>';
        return;
      }

      clients.forEach(client => {
        if (!client.pets) return;

        client.pets.forEach(pet => {
          if (!pet.sessions || !Array.isArray(pet.sessions)) return;

          pet.sessions.forEach(session => {
            const sessionData = {
              date: session.createdAt || session.date || '‚Äî',
              owner: client.owner || '‚Äî',
              pet: pet.name || '‚Äî',
              pkg: session.pkg || '‚Äî',
              price: `‚Ç±${(session.price || 0).toFixed(2)}`,
              groomer: session.groomer || '‚Äî'
            };

            allSessions.push(sessionData);

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${sessionData.date}</td>
              <td>${sessionData.owner}</td>
              <td>${sessionData.pet}</td>
              <td>${sessionData.pkg}</td>
              <td>${sessionData.price}</td>
              <td>${sessionData.groomer}</td>
            `;
            tableBody.appendChild(row);
          });
        });
      });

      if (allSessions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6">No sessions found.</td></tr>';
      }
    }

    function exportData() {
      const choice = confirm("OK = Export as PDF\nCancel = Export as Excel");
      const filename = `session_summary_${Date.now()}`;

      if (choice) {
        exportAsPDF(filename);
      } else {
        exportAsExcel(filename);
      }
    }

    function exportAsPDF(filename) {
      const { jsPDF } = require('jspdf');
      require('jspdf-autotable');

      const doc = new jsPDF();
      doc.text("Grooming Session Summaries", 14, 16);
      doc.autoTable({
        startY: 20,
        head: [['Date', 'Owner', 'Pet', 'Package', 'Total', 'Groomer']],
        body: allSessions.map(s => [s.date, s.owner, s.pet, s.pkg, s.price, s.groomer])
      });
      doc.save(`${filename}.pdf`);
    }

    function exportAsExcel(filename) {
      const XLSX = require('xlsx');
      const worksheet = XLSX.utils.json_to_sheet(allSessions);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Sessions");
      XLSX.writeFile(workbook, `${filename}.xlsx`);
    }

    loadSessionsFromClients();
  </script>
</body>
</html>
